# GitHub Copilot Instructions â€” Hybrid Training Platform

> Goal: Make Copilot an effective coâ€‘developer for this multiâ€‘tenant hybrid training app (mobile PWA + web admin, Node/TypeScript API, PostgreSQL w/ RLS), maximising developer productivity and test quality. This guide defines **context**, **conventions**, **prompt patterns**, and **local container testing** (with start/stop scripts).

---

## TL;DR for Copilot
- **Stack**: PWA (React/Next), Node/TypeScript API (REST or tRPC), PostgreSQL 15+ with **Row Level Security**. Tests via **Vitest/Jest**, API tests via **Supertest**, e2e via **Playwright**. ORM optional (Drizzle or Prisma), but **raw SQL for RLS** policies.
- **Key domain rules**:
  - `sessions.category âˆˆ {strength, cardio, hybrid}` (required).
  - Each **set** has **two configurable variables**, both chosen from `{weight_kg, distance_m, duration_s, calories}` with independent selection.
- **Principles**: strict types, Zod validation on I/O, pure functions, DI for infra, idempotent migrations, deterministic tests.
- **Local dev** uses containers. See `scripts/start.sh` and `scripts/stop.sh` templates below.

---

## 1) Repository Shape (suggested)
```
apps/
  web/               # Next.js PWA (app router, service worker, offline cache)
  api/               # Node/TS API (Express/tRPC/Fastify), Zod schemas
packages/
  db/                # SQL migrations, drizzle/prisma client, RLS helpers
  ui/                # Shared UI libs/components (shadcn/ui, charts)
  config/            # ESLint, Prettier, TS config, env schema, logger
scripts/
  start.sh           # container bootstrap (compose up, migrate, seed)
  stop.sh            # container teardown (compose down, prune opt-in)
docker/
  docker-compose.yml # web, api, db (postgres), worker, mailhog
  Dockerfile.api
  Dockerfile.web
```

**Copilot hint**: Prefer generating files into these paths. If unsure, ask in Copilot Chat: *â€œWhere should I place X?â€*

---

## 2) Coding Conventions
- **TypeScript**: `"strict": true`, `noUncheckedIndexedAccess`, `exactOptionalPropertyTypes`.
- **Validation**: Zod schemas mirror DB constraints. Parse at the edge (request/response).
- **Errors**: Never throw raw; wrap in typed error objects and map to HTTP problem details.
- **Auth**: JWT (shortâ€‘lived access + rotating refresh). User â†’ Tenant scoping via `tenant_id` in claims; verify against DB on each request for write operations.
- **Database**: PostgreSQL 15+. **RLS enabled** on all tenant tables; use policies by `tenant_id`. Prefer SQL migrations for RLS (clear diffing). ORM is acceptable for models.
- **Time**: Store in UTC (TIMESTAMPTZ). Client displays local time.
- **Units**: Metric by default. Enforce set variable **types** via enum: `set_value_type`.
- **Logging**: Structured JSON logs (pino or similar) with correlation IDs; OpenTelemetry traces optional.
- **Security**: Parameterized queries; never stringâ€‘concatenate SQL. Denyâ€‘byâ€‘default CORS; rateâ€‘limit auth routes.

---

## 3) Domain Rules (for Copilot)
**Sessions**
- `category: 'strength' | 'cardio' | 'hybrid'` (required).

**Sets**
- Fields: `reps? number`, `value_1_type?`, `value_1_numeric?`, `value_2_type?`, `value_2_numeric?`, `rpe?`.
- `value_*_type âˆˆ {'weight_kg','distance_m','duration_s','calories'}`. Either/both can be null; if both present and are `distance_m` + `duration_s`, derive **pace** on the API.
- Reject negatives. Large bounds sanityâ€‘checked in API layer.

**Analytics**
- Strength **volume** = Î£(weight_kg Ã— reps) for strength + hybrid sessions (where applicable).
- **Pace** = distance_m / duration_s when both exist.
- **PRs**: 1RM estimators (Epley/Brzycki) for lifts when reps+weight present.

---

## 4) Prompt Patterns That Work
> Add to file headers or Copilot Chat to steer suggestions.

### Implement a feature
```
/* Goal: Add POST /sessions
   Constraints:
   - Validate body with Zod: { startedAt?, category: enum, notes? }
   - Attach tenant_id from auth claims
   - Insert with RLS active (no bypass)
   - Return 201 with created entity (camelCase), problem+json on error
   Tests:
   - happy path
   - missing/invalid category
   - forbidden cross-tenant insert (RLS) */
```

### Generate unit tests
```
/* Create Vitest tests for pace and 1RM helpers.
   - Boundary tests (duration 0 -> error)
   - Typical cases and floating-point rounding (2 decimals)
   - Property: duration_s > 0 and distance_m >= 0 */
```

### Write a migration (SQL)
```
-- Create sets value enums, add columns
-- Idempotent, transactional, rollback comment
```

### Refactor to pure functions
```
/* Extract DB side-effects; keep pure calculators (pace, 1RM) testable */
```

### Produce e2e tests (Playwright)
```
# Login + offline logging + sync reconciliation scenario
```

---

## 5) File & Comment Cues for Copilot
- Start files with a **purpose comment** and list of **acceptance criteria**.
- In tests, preface with `// Scenarios:` and bullet points.
- For SQL, include `-- up` and `-- down` sections or clear comments for idempotency.
- Provide brief examples of expected inputs/outputs for validators.

**Example file header (API route):**
```ts
/** POST /sessions
 * Accepts: { category: 'strength'|'cardio'|'hybrid', startedAt?: string, notes?: string }
 * Behavior: attaches tenant_id from JWT; RLS enforced
 * Returns: 201 {session} | 400 | 401 | 403 | 500
 * Tests: unit (zod), integration (supertest), e2e (playwright) */
```

---

## 6) Local Containers (Start/Stop)
> Use these as templates. Place in `scripts/` and make them executable (`chmod +x`).

**scripts/start.sh**
```bash
#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT_DIR"

export COMPOSE_PROJECT_NAME=rythmapp
export POSTGRES_PASSWORD=postgres
export POSTGRES_USER=postgres
export POSTGRES_DB=hybrid_local

echo "â–¶ Building and starting containers..."
docker compose -f docker/docker-compose.yml up -d --build

echo "â–¶ Waiting for Postgres..."
until docker exec rythmapp-db pg_isready -U "$POSTGRES_USER" >/dev/null 2>&1; do
  sleep 1
done

echo "â–¶ Applying migrations and seeds..."
# Example using drizzle; swap for prisma or raw SQL runner
pnpm --filter @app/api db:migrate
pnpm --filter @app/api db:seed

echo "âœ… Environment ready at http://localhost:3000 (web) and http://localhost:4000 (api)"
```

**scripts/stop.sh**
```bash
#!/usr/bin/env bash
set -euo pipefail

cd "$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

export COMPOSE_PROJECT_NAME=rythmapp

echo "â¹ Stopping containers..."
docker compose -f docker/docker-compose.yml down

read -r -p "Also remove volumes? This deletes local DB data. (y/N) " yn
case "$yn" in
  [Yy]* ) docker volume prune -f ;;
  * ) echo "Keeping volumes." ;;
esac

echo "ğŸ§¹ Done."
```

**docker/docker-compose.yml (excerpt)**
```yaml
version: "3.9"
services:
  db:
    container_name: rythmapp-db
    image: postgres:15
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-hybrid_local}
    ports: ["5432:5432"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - db_data:/var/lib/postgresql/data

  api:
    build:
      context: ../
      dockerfile: docker/Dockerfile.api
    env_file: .env.local
    depends_on: [db]
    ports: ["4000:4000"]

  web:
    build:
      context: ../
      dockerfile: docker/Dockerfile.web
    env_file: .env.local
    depends_on: [api]
    ports: ["3000:3000"]

volumes:
  db_data: {}
```

---

## 7) Testing Guidance (for Copilot)
- **Unit**: calculators (pace, 1RM), mappers, guards. 100% branch coverage aimed here.
- **Integration**: API + DB with a **test schema**. Wrap each test in a transaction and roll back.
- **RLS tests**: prove crossâ€‘tenant queries fail; sameâ€‘tenant succeed.
- **e2e**: Offline log â†’ reconnect â†’ conflict resolution (server wins with deterministic merge).

**Example Vitest sketch**
```ts
import { describe, it, expect } from 'vitest';
import { pace } from '../lib/calc';

describe('pace', () => {
  it('computes m/s when both inputs valid', () => {
    expect(pace(2000, 400)).toBeCloseTo(5, 5);
  });
  it('throws on zero/negative duration', () => {
    expect(() => pace(1000, 0)).toThrow();
  });
});
```

---

## 8) Copilot Chat: Handy Prompts
- â€œGenerate a Zod schema and TS type for a set with two variable fields; enforce enums.â€
- â€œCreate SQL for an `enum set_value_type` and alter `sets` to add `value_1_*` and `value_2_*` columns idempotently.â€
- â€œWrite Playwright tests for offline logging then sync.â€
- â€œRefactor controller to pure functions + dependency injection; create test doubles.â€
- â€œDraft RLS policies for tenant isolation on `sessions` and `sets` using `tenant_id` and `auth.jwt()`. Add tests.â€

---

## 9) Editor/Tooling Settings
- `.editorconfig` for spaces, LF, utfâ€‘8.
- ESLint + Prettier configured; preâ€‘commit hook with `lint-staged`.
- VS Code: enable Copilot + Copilot Chat, TypeScript SDK workspace version, â€œFormat on Saveâ€.
- `.copilotignore` to omit large datasets or generated clients from context if needed.

---

## 10) PRs & Commits
- Conventional commits (`feat:`, `fix:`, `chore:`â€¦). Scope by package when possible.
- PR template: problem, approach, screenshots, **tests** added, risk & rollback.
- Require green unit/integration CI and at least one RLS test for dataâ€‘layer changes.

---

## 11) Common Antiâ€‘patterns (Ask Copilot to avoid)
- Disabling RLS or using `SECURITY DEFINER` without review.
- Mixing validation, business logic, and IO in the same function.
- Returning DB shapes directly to clients (no DTO mapping).

---

## 12) Quick Stubs (Copilot seeds)

**Zod session schema**
```ts
export const SessionCreate = z.object({
  category: z.enum(['strength','cardio','hybrid']),
  startedAt: z.coerce.date().optional(),
  notes: z.string().max(2000).optional(),
});
```

**Pace calculator**
```ts
export function pace(distance_m: number, duration_s: number) {
  if (duration_s <= 0 || distance_m < 0) throw new Error('invalid');
  return distance_m / duration_s; // m/s
}
```

**1RM (Epley)**
```ts
export function oneRmEpley(weight_kg: number, reps: number) {
  if (weight_kg <= 0 || reps <= 0) throw new Error('invalid');
  return weight_kg * (1 + reps / 30);
}
```

---

## 13) Final Notes
- Keep comments crisp and actionâ€‘oriented so Copilot has the right guardrails.
- Prefer testâ€‘first on calculators and RLS policies; Copilot then fills in safe scaffolding.
- When in doubt, ask Copilot Chat to **explain its suggestion** and request safer alternatives.
